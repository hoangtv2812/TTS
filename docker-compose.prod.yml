services:
  gateway:
    image: vhoang2812/server_image:tts_gateway
    ports:
      - "80:80"
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        order: start-first
        failure_action: rollback
        delay: 5s
      rollback_config:
        parallelism: 0
        order: stop-first
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 5s
    networks:
      tts_network:
        aliases:
          - tts_gateway
    depends_on:
      - backend
      - frontend

  backend:
    image: vhoang2812/server_image:tts_backend
    # Ports removed to secure service behind gateway
    volumes:
      - ./backend/public:/app/public
    env_file:
      - "./backend/docker/docker-compose.env"
    networks:
      tts_network:
        aliases:
          - tts_backend
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 2
        order: start-first
        failure_action: rollback
        delay: 5s
      rollback_config:
        parallelism: 0
        order: stop-first
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 5s
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://127.0.0.1:3001/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    image: vhoang2812/server_image:tts_frontend
    # Ports removed to secure service behind gateway
    networks:
      tts_network:
        aliases:
          - tts_frontend
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 2
        order: start-first
        failure_action: rollback
        delay: 5s
      rollback_config:
        parallelism: 0
        order: stop-first
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 5s
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  tts_network:
    name: "tts_network_prod"

