name: Test Frontend Rollback (Manual)

on:
  push:
    branches:
      - test_deploy_frontend

jobs:
  test_rollback_behavior:
    runs-on: ubuntu-latest
    steps:
      - name: SSH to VPS and Trigger Bad Update
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST_TTS }}
          username: ${{ secrets.SERVER_USER_TTS }}
          key: ${{ secrets.SSH_PRIVATE_KEY_TTS }}
          port: ${{ secrets.SERVER_PORT_TTS }}
          script: |
            SERVICE_NAME="tts_frontend"

            echo "========================================================"
            echo "üîç TR·∫†NG TH√ÅI HI·ªÜN T·∫†I:"
            docker service ps $SERVICE_NAME --filter "desired-state=running" --no-trunc

            echo "========================================================"
            echo "üí£ B·∫ÆT ƒê·∫¶U G√ÇY L·ªñI (Simulate Bad Deployment)..."
            echo "üëâ L·ªánh: docker service update --health-cmd 'exit 1' ..."

            # C·∫≠p nh·∫≠t service v·ªõi Healthcheck lu√¥n fail (exit 1)
            # --update-failure-action rollback: ƒê·∫£m b·∫£o Swarm s·∫Ω rollback khi fail
            # --update-monitor 10s: Th·ªùi gian theo d√µi l·ªói
            # --detach=true: Ch·∫°y ng·∫ßm ƒë·ªÉ ta c√≥ th·ªÉ in log quan s√°t ·ªü d∆∞·ªõi

            docker service update \
              --health-cmd "exit 1" \
              --health-interval 5s \
              --health-retries 2 \
              --update-monitor 15s \
              --force \
              --detach=true \
              $SERVICE_NAME

            echo "‚úÖ ƒê√£ g·ª≠i l·ªánh update. ƒêang theo d√µi qu√° tr√¨nh Rollback..."
            echo "========================================================"

            # V√≤ng l·∫∑p theo d√µi trong 60 gi√¢y
            START_TIME=$(date +%s)
            while true; do
                CURRENT_TIME=$(date +%s)
                ELAPSED=$((CURRENT_TIME - START_TIME))

                if [ $ELAPSED -gt 90 ]; then
                    echo "H·∫øt th·ªùi gian theo d√µi."
                    break
                fi

                echo "--- Time: ${ELAPSED}s ---"
                # In ra danh s√°ch task, hi·ªÉn th·ªã c·∫£ task c≈© v√† m·ªõi
                docker service ps $SERVICE_NAME --no-trunc | head -n 10
                echo "------------------------"

                # Ki·ªÉm tra xem c√≥ task n√†o b·ªã rollback ch∆∞a
                # Tr·∫°ng th√°i rollback th∆∞·ªùng ƒë·ªÉ l·∫°i d·∫•u v·∫øt l√† task m·ªõi b·ªã Shutdown/Failed v√† task c≈© Running

                sleep 5
            done

            echo "========================================================"
            echo "üîç K·∫æT QU·∫¢ CU·ªêI C√ôNG:"
            docker service ps $SERVICE_NAME --filter "desired-state=running" --no-trunc

            # Ki·ªÉm tra xem healthcheck ƒë√£ quay v·ªÅ ban ƒë·∫ßu ch∆∞a (kh√¥ng ph·∫£i exit 1)
            CURRENT_HEALTH_CMD=$(docker service inspect $SERVICE_NAME --format '{{.Spec.TaskTemplate.ContainerSpec.Healthcheck.Test}}')
            echo "Healthcheck Command hi·ªán t·∫°i: $CURRENT_HEALTH_CMD"

            if [[ "$CURRENT_HEALTH_CMD" == *"[exit 1]"* ]]; then
               echo "‚ùå TEST TH·∫§T B·∫†I: Service v·∫´n gi·ªØ c·∫•u h√¨nh l·ªói (Ch∆∞a rollback)."
               exit 1
            else
               echo "‚úÖ TEST TH√ÄNH C√îNG: Service ƒë√£ rollback v·ªÅ c·∫•u h√¨nh c≈© (Healthcheck chu·∫©n)."
            fi
