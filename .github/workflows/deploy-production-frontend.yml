name: Frontend CI/CD Pipeline

on:
  push:
    branches:
      - deploy-frontend-production

jobs:
  build_push_frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/server_image:tts_frontend_${{ github.sha }}
          platforms: linux/amd64
          build-args: |
            VITE_BACKEND_SERVER=${{ secrets.VITE_BACKEND_SERVER }}

  deploy_frontend:
    needs: build_push_frontend
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Deploy Frontend to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST_TTS }}
          username: ${{ secrets.SERVER_USER_TTS }}
          key: ${{ secrets.SSH_PRIVATE_KEY_TTS }}
          port: ${{ secrets.SERVER_PORT_TTS }}
          script: |
            set -e
            cd ~/Workspace/tts

            STACK_NAME=tts
            SERVICE_NAME=tts_frontend
            NEW_FRONTEND_TAG=${{ secrets.DOCKER_HUB_USERNAME }}/server_image:tts_frontend_${{ github.sha }}

            echo "üîç Fetching currently running images for Backend and Gateway..."
            # L·∫•y image ID ƒë·∫ßy ƒë·ªß (th∆∞·ªùng c√≥ d·∫°ng username/repo:tag@sha256:...)
            # N·∫øu service ch∆∞a ch·∫°y, fallback v·ªÅ image m·∫∑c ƒë·ªãnh trong file compose (nh∆∞ng kh√¥ng c√≥ SHA)

            CURRENT_BACKEND=$(docker service inspect tts_backend --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' 2>/dev/null)
            if [ -z "$CURRENT_BACKEND" ]; then
                echo "‚ö†Ô∏è Backend not running, using default placeholder."
                CURRENT_BACKEND="vhoang2812/server_image:tts_backend"
            fi

            CURRENT_GATEWAY=$(docker service inspect tts_gateway --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' 2>/dev/null)
            if [ -z "$CURRENT_GATEWAY" ]; then
                echo "‚ö†Ô∏è Gateway not running, using default placeholder."
                CURRENT_GATEWAY="vhoang2812/server_image:tts_gateway"
            fi

            echo "üìå Pinning Backend to: $CURRENT_BACKEND"
            echo "üìå Pinning Gateway to: $CURRENT_GATEWAY"

            # Git operations
            git fetch origin deploy-frontend-production
            git reset --hard origin/deploy-frontend-production

            # Docker Login & Pull NEW Image
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin
            docker pull "$NEW_FRONTEND_TAG"

            # Prepare Compose File
            cp docker-compose.prod.yml docker-compose.deploy.yml

            # --- KEY STEP: REPLACE IMAGES ---
            # D√πng comment anchor (# image_...) ƒë·ªÉ thay th·∫ø ch√≠nh x√°c d√≤ng

            # 1. Update Frontend -> Image M·ªõi
            sed -i "s|image: .* # image_frontend|image: ${NEW_FRONTEND_TAG} # image_frontend|g" docker-compose.deploy.yml

            # 2. Pin Backend -> Image C≈© (ƒëang ch·∫°y)
            sed -i "s|image: .* # image_backend|image: ${CURRENT_BACKEND} # image_backend|g" docker-compose.deploy.yml

            # 3. Pin Gateway -> Image C≈© (ƒëang ch·∫°y)
            sed -i "s|image: .* # image_gateway|image: ${CURRENT_GATEWAY} # image_gateway|g" docker-compose.deploy.yml

            # Check n·ªôi dung file sau khi s·ª≠a (ƒë·ªÉ debug)
            echo "üìÑ Docker Compose Config Preview (Images):"
            grep "image:" docker-compose.deploy.yml

            # Deploy Stack
            echo "üöÄ Deploying stack (Frontend Update Only)..."
            docker stack deploy --with-registry-auth --compose-file docker-compose.deploy.yml "$STACK_NAME"

            # Wait & Verify for Frontend ONLY
            echo "‚è≥ Waiting for '$SERVICE_NAME' to stabilize..."

            for i in {1..24}; do
              REPLICAS=$(docker service ls --filter name=$SERVICE_NAME --format "{{.Replicas}}")
              AVAILABLE=$(echo $REPLICAS | cut -d'/' -f1)
              DESIRED=$(echo $REPLICAS | cut -d'/' -f2)

              # L·∫•y image ƒëang ch·∫°y th·ª±c t·∫ø c·ªßa Frontend
              DEPLOYED_IMAGE=$(docker service ps $SERVICE_NAME --filter "desired-state=running" --format "{{.Image}}" | head -n 1 | cut -d'@' -f1)

              if [ "$AVAILABLE" == "$DESIRED" ] && [ "$DEPLOYED_IMAGE" == "$NEW_FRONTEND_TAG" ]; then
                echo "‚úÖ Service '$SERVICE_NAME' is stable and running correct version: $DEPLOYED_IMAGE"
                rm docker-compose.deploy.yml
                docker system prune -f
                exit 0
              fi

              echo "   ... waiting ($i/24): Replicas $REPLICAS, Image: $DEPLOYED_IMAGE"
              sleep 5
            done

            echo "‚ùå Timeout: Service did not stabilize."
            docker service ps $SERVICE_NAME --no-trunc
            exit 1

      - name: Notify GitHub on success
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            try {
              github.rest.repos.createCommitComment({
                owner: '${{ github.repository_owner }}',
                repo: '${{ github.event.repository.name }}',
                commit_sha: '${{ github.sha }}',
                body: '‚úÖ Frontend Deployment Successful (Backend/Gateway Preserved)!'
              });
            } catch (error) { console.log(error); }

      - name: Notify Google Chat on success
        if: success()
        run: |
          curl -X POST -H 'Content-Type: application/json' \
            -d '{"text": "‚úÖ *[TTS Frontend] Deployment successful !*\n- Workflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"}' \
            '${{ secrets.GOOGLE_CHAT_WEBHOOK }}'

      - name: Notify GitHub on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            try {
              github.rest.repos.createCommitComment({
                owner: '${{ github.repository_owner }}',
                repo: '${{ github.event.repository.name }}',
                commit_sha: '${{ github.sha }}',
                body: '‚ùå Frontend Deployment Failed!'
              });
            } catch (error) { console.log(error); }

      - name: Notify Google Chat on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-Type: application/json' \
            -d '{"text": "‚ùå *[TTS Frontend] Deployment failed !*\n- Workflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"}' \
            '${{ secrets.GOOGLE_CHAT_WEBHOOK }}'
